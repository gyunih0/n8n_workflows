{
  "name": "news_rag_chatbot",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Telegram Trigger').item.json.message.text }}",
        "options": {
          "systemMessage": "=# 역할: \n당신은 뉴스 검색 & 웹 검색 지원 에이전트입니다.  \n당신의 역할은 사용자의 질문을 받아 벡터 데이터베이스(Vector DB)에서 관련 뉴스 데이터를 검색하고 요약하여 텔레그램 메시지로 전송할 메시지를 만드는 것입니다.  \n만약 벡터 DB에서 적절한 정보를 찾지 못하거나 사용자가 웹 검색을 요청하는 경우, 별도로 제공된 `web_search_tool`을 사용하여 정보를 수집하고 답변해야 합니다.\n\n---\n\n## 동작 원칙\n\n1. **1단계 – Vector DB 검색**  \n   - 항상 먼저 벡터 DB에서 사용자의 질문과 의미적으로 관련된 뉴스를 검색합니다.  \n   - 관련 기사가 있다면 핵심 내용을 요약하고, 이해하기 쉽게 정리해서 텔레그램 메시지로 보냅니다.\n\n2. **2단계 – 웹 검색 툴 사용 (보조 단계)**  \n   - 아래 상황 중 하나에 해당하면 `web_search_tool`을 사용합니다:\n     - 벡터 DB에서 관련 정보를 찾지 못했거나 너무 오래된 경우 \n     - 검색 결과가 부정확하거나 불충분한 경우  \n     - 사용자가 “실시간”, “웹에서 찾아줘” 등의 단어로 웹 검색을 명시적으로 요청한 경우  \n   - 웹 검색을 사용한 경우, 결과를 요약하면서 반드시 “🔎 웹 검색 결과를 기반으로 정리한 내용입니다.”라는 문구를 포함합니다.\n\n3. **3단계 – 결과 없음 처리 (최종 대응)**  \n   - 벡터 DB와 웹 검색 모두에서 관련 정보를 찾을 수 없거나, 제공할 만한 내용이 전혀 없는 경우 반드시 아래 중 하나와 같은 메시지를 사용자에게 보내야 합니다:\n     - “❗ 관련된 뉴스를 찾을 수 없습니다.”  \n     - “현재 해당 주제에 대한 뉴스나 정보를 확인할 수 없습니다.”  \n     - “죄송합니다. 요청하신 내용과 관련된 데이터를 찾지 못했습니다.”  \n\n---\n\n## 응답 작성 규칙\n\n- 텔레그램 메시지로 전송되므로 **짧고 명확한 한국어**로 답변합니다.  \n- 최대 10문장 이내로 요약하고, 필요 시 핵심 포인트를 불릿 포인트로 정리합니다.  \n- 가능하다면 기사 날짜, 출처, 맥락을 함께 제공합니다.  \n- 응답 구조는 아래 형식을 따르는 것을 권장합니다:\n  - 📰 **요약:** [핵심 내용 요약]  \n  - 📌 **핵심 포인트:**  \n    - [포인트 1]  \n    - [포인트 2]  \n    - [포인트 3]\n- 웹 검색을 사용한 경우 마지막에 다음 문장을 추가합니다:  \n  “🔎 웹 검색 결과를 기반으로 정리한 내용입니다.”\n\n---\n\n## 동작 예시\n\n- 사용자: “삼성전자 최근 AI 투자 소식 알려줘”  \n  - → 벡터 DB에서 관련 뉴스 검색 → 있으면 요약 후 응답  \n  - → 없거나 오래된 경우 → `web_search_tool` 사용 → 결과 요약  \n  - → 그래도 없으면 “❗ 관련된 뉴스를 찾을 수 없습니다.” 라고 응답\n\n- 사용자: “웹에서 최신 뉴스만 찾아줘”  \n  - → 벡터 DB 생략 → `web_search_tool` 사용 → 요약  \n  - → 결과가 없으면 “현재 해당 주제에 대한 뉴스나 정보를 확인할 수 없습니다.” 라고 응답\n\n---\n\n📌 반드시 위의 흐름과 규칙을 따르고, 어떠한 상황에서도 빈 응답을 보내지 말고 항상 명확한 메시지를 반환해야 합니다."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -64,
        -208
      ],
      "id": "1c359151-03a2-4464-a3a0-545d0b0de4d4",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -128,
        -32
      ],
      "id": "f3036095-5719-4fb5-9d9c-cc1e449bbf06",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "4b9A0wVGSHlfntWd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "뉴스 벡터 검색 툴",
        "topK": 5
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1.1,
      "position": [
        112,
        0
      ],
      "id": "47ec2727-1d13-4c8b-808d-ba5ec5494252",
      "name": "news_vector_tool"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -16,
        288
      ],
      "id": "fd3bc3b8-0a6c-474c-9ee0-a4cf5f2dd698",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "4b9A0wVGSHlfntWd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        256,
        144
      ],
      "id": "50dae5ff-dad6-4463-ae8c-6251f12af599",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "4b9A0wVGSHlfntWd",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "description": "웹 검색을 위한 툴",
        "workflowId": {
          "__rl": true,
          "value": "YuHzXa09hMhuqaFs",
          "mode": "list",
          "cachedResultName": "search tool"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        416,
        32
      ],
      "id": "e783b24c-817f-4fe1-8063-0b3a3bf966c7",
      "name": "web_search_tool"
    },
    {
      "parameters": {
        "content": "## 뉴스 RAG(+웹검색) 챗봇",
        "height": 736,
        "width": 1104,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -496,
        -288
      ],
      "typeVersion": 1,
      "id": "0063ee76-ca9f-463e-8dfa-157dbe0efaac",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        -16,
        144
      ],
      "id": "810121c3-cdc3-4135-802f-a49f2f06be33",
      "name": "Supabase Vector Store1",
      "credentials": {
        "supabaseApi": {
          "id": "EAPIK5MffbAbmOZS",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -464,
        -208
      ],
      "id": "ce314d05-114b-48df-b4aa-57775d4a3179",
      "name": "Telegram Trigger",
      "webhookId": "b06daf9e-5b8e-4bbc-819c-a67e89ee20e2",
      "credentials": {
        "telegramApi": {
          "id": "mqqU3hj8HMV1gEiC",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.update_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        16,
        0
      ],
      "id": "c5084013-78bd-4e71-b2b7-5171b327791b",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "fKKmu8VonqG0eAEM",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "7433818481",
        "text": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        336,
        -208
      ],
      "id": "967eed7c-03cc-4c02-b5a5-131e0776a73c",
      "name": "Send a text message",
      "webhookId": "99114276-f7c2-4c30-936f-5db8de765c78",
      "credentials": {
        "telegramApi": {
          "id": "mqqU3hj8HMV1gEiC",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendChatAction",
        "chatId": "={{ $json.message.from.id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -272,
        -208
      ],
      "id": "06b8027f-d127-4c9f-bb34-ec579e552f8c",
      "name": "Send a chat action",
      "webhookId": "7fbac06a-17a8-45d5-bd8a-32f7274c02e6",
      "credentials": {
        "telegramApi": {
          "id": "mqqU3hj8HMV1gEiC",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "news_vector_tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "news_vector_tool",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "web_search_tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store1": {
      "ai_vectorStore": [
        [
          {
            "node": "news_vector_tool",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Send a chat action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a chat action": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4975dfdb-57ca-458f-97a3-98ded530a53d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "558d88703fb65b2d0e44613bc35916258b0f0bf983c5d4730c00c424b77ca36a"
  },
  "id": "uOIrhYipzYa4cUNe",
  "tags": []
}